pipeline {
  agent any

  parameters {
    string(name: 'SERVICE_REPO', defaultValue: '', description: 'git repo of the microservice (e.g., https://github.com/rujool11/chirp-auth-service.git)')
    choice(name: 'SERVICE_NAME', choices: ['auth-service', 'core-service', 'api-gateway'], description: 'service to build')
  }

  environment {
    REGISTRY = "rujool11"
  }

  stages {

    stage('clone microservice repo') {
      steps {
        git branch: 'main', url: "${params.SERVICE_REPO}"
      }
    }

    stage('inject environment variables') {
      steps {
        script {
          if (params.SERVICE_NAME == 'auth-service') {
            withCredentials([
              string(credentialsId: 'DB_CONNECTION_STRING', variable: 'DB_STRING'),
              string(credentialsId: 'JWT_SECRET', variable: 'JWT')
            ]) {
              writeFile file: '.env', text: """DB_CONNECTION_STRING=${DB_STRING}
                                            JWT_SECRET=${JWT}
                                            PORT=8001
                                            """
            }
          } else if (params.SERVICE_NAME == 'core-service') {
            withCredentials([
              string(credentialsId: 'DB_CONNECTION_STRING', variable: 'DB_STRING'),
              string(credentialsId: 'JWT_SECRET', variable: 'JWT')
            ]) {
              writeFile file: '.env', text: """DB_CONNECTION_STRING=${DB_STRING}
                                            JWT_SECRET=${JWT}
                                            PORT=8002
                                            """
            }
          } else if (params.SERVICE_NAME == 'api-gateway') {
            withCredentials([
              string(credentialsId: 'AUTH_URL', variable: 'AUTH_URL'),
              string(credentialsId: 'CORE_URL', variable: 'CORE_URL')
            ]) {
              writeFile file: '.env', text: """AUTH_URL=${AUTH_URL}
                                            CORE_URL=${CORE_URL}
                                            PORT=8000
                                            """
            }
          }
        }
      }
    }

    stage('build and push docker image') {
      steps {
        script {
          // extract current version from cicd repo manifest
          dir('../chirp-cicd') {
            withCredentials([string(credentialsId: 'git-token', variable: 'GITHUB_TOKEN')]) {
              sh """
                if [ ! -d .git ]; then
                  git clone https://${GITHUB_TOKEN}@github.com/rujool11/chirp-cicd.git .
                fi
              """
            }
          }

          def currentVersion = sh(
            script: "grep 'image:' ../chirp-cicd/k8s/${params.SERVICE_NAME}-deployment.yaml | sed -E 's/.*:(v0\\.)([0-9]+)/\\2/'",
            returnStdout: true
          ).trim()
          if (!currentVersion) { currentVersion = "0" }

          def newMinor = (currentVersion.toInteger() + 1)
          def newVersion = "v0.${newMinor}"

          echo "building ${params.SERVICE_NAME} -> ${REGISTRY}/${params.SERVICE_NAME}:${newVersion}"

          // login to dockerhub and build/push
          withCredentials([usernamePassword(credentialsId: 'dockerhub', usernameVariable: 'DOCKER_USER', passwordVariable: 'DOCKER_PASS')]) {
            sh """
              echo "$DOCKER_PASS" | docker login -u "$DOCKER_USER" --password-stdin
              docker build -t ${REGISTRY}/${params.SERVICE_NAME}:${newVersion} .
              docker push ${REGISTRY}/${params.SERVICE_NAME}:${newVersion}
            """
          }

          // save the new version for next stages
          env.NEW_VERSION = newVersion
        }
      }
    }

    stage('update k8s manifest') {
      steps {
        script {
          // update image version in manifest
          sh """
            sed -i 's|${REGISTRY}/${params.SERVICE_NAME}:.*|${REGISTRY}/${params.SERVICE_NAME}:${env.NEW_VERSION}|' ../chirp-cicd/k8s/${params.SERVICE_NAME}-deployment.yaml
          """

          // commit and push updated manifest
          dir('../chirp-cicd') {
            withCredentials([string(credentialsId: 'git-token', variable: 'GITHUB_TOKEN')]) {
              sh """
                git config --global user.email "jenkins@chirp.local"
                git config --global user.name "jenkins ci"
                git add k8s/${params.SERVICE_NAME}-deployment.yaml
                git commit -m "ci: bump ${params.SERVICE_NAME} to ${env.NEW_VERSION}" || echo "no changes to commit"
                git pull --rebase origin main
                git push origin main
              """
            }
          }
        }
      }
    }

    stage('trigger cd pipeline') {
      when {
        expression {
          // only trigger CD if docker build/push succeeded
          return env.NEW_VERSION != null && env.NEW_VERSION != ''
        }
      }
      steps {
        echo "triggering cd deployment for ${params.SERVICE_NAME}:${env.NEW_VERSION}"
        build job: 'Chirp-CD', parameters: [
          string(name: 'SERVICE_DEPLOYED', value: "${params.SERVICE_NAME}"),
          string(name: 'SERVICE_VERSION', value: "${env.NEW_VERSION}")
        ]
      }
    }
  }

  post {
    failure {
      echo "ci pipeline failed for ${params.SERVICE_NAME}"
    }
    success {
      echo "ci pipeline completed successfully for ${params.SERVICE_NAME}:${env.NEW_VERSION}"
    }
  }
}
